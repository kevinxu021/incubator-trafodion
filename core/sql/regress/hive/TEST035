-- -*- mode: sql; coding: utf-8 -*-
-- Tests for insert into ORC tables
--
-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@

sh regrhadoop.ksh fs -mkdir  /user/hive/exttables/customer_ddl_orc;
sh regrhadoop.ksh fs -mkdir  /user/hive/exttables/customer_temp_orc;

sh regrhadoop.ksh fs -rm   /user/hive/exttables/customer_ddl_orc/*;
sh regrhadoop.ksh fs -rm   /user/hive/exttables/customer_temp_orc/*;

--- setup Orc tables
sh regrhive.ksh -v -f $REGRTSTDIR/TEST035_a.orc.sql;

log LOG035 clear;

set schema hive.hive;
set terminal_charset utf8;

cqd AUTO_QUERY_RETRY_WARNINGS 'ON';
cqd HIVE_MAX_STRING_LENGTH '32' ;
cqd hist_missing_stats_warning_level '0';

cqd HIST_ROWCOUNT_REQUIRING_STATS '50000';
------------------------------------------------------------
-- Testing query plan invalidation in the compiler, but
-- not the executor. Perform DML/DDL operations on a
-- table and try re-executing the old plan as well as
-- getting a query cache hit and updating the changed
-- Hive and HDFS metadata
------------------------------------------------------------

prepare s1 from 
  select c_preferred_cust_flag,
         count(*) 
  from customer_temp_orc
  group by 1 
  order by 1
  ;
execute s1;
-- expect 0 rows

prepare s1part from 
  select c_preferred_cust_flag,
         count(*) 
  from customer_p_orc
  group by 1 
  order by 1
  ;
execute s1part;
-- expect 0 rows

insert into hive.hive.hivenonp_orc
values -- partition 1,one
       (1,1,1,'one', timestamp '2001-01-01 01:23:45.678901', date '2001-01-01'),
       (11,11,1,'one', timestamp '2001-01-01 01:23:45.678901', date '2001-01-01'),
       -- partition 2,two
       (2,2,2,'two', timestamp '2002-02-02 02:34:56.789012', date '2020-02-29'),
       (22,22,2,'two', timestamp '2002-02-02 00:00:00.000000', date '2020-02-29'),
       (222,222,2,'two', timestamp '2002-02-02 02:34:56.789012', date '2020-02-29'),
       -- partition 3,three
       (3,3,3,'three', timestamp '2003-03-03 03:45:57.890123', date '2003-03-31'),
       -- partition 3 or partition 3,four
       (34,34,3,'four', timestamp '2004-04-04 04:56:18', date '2004-04-04');
select * from hive.hive.hivenonp_orc;

insert into hive.hive.hivepis_orc select id, col2, p1, p2 from hive.hive.hivenonp_orc;
insert into hive.hive.hivepts_orc select id, col2, p1t, p2 from hive.hive.hivenonp_orc;
insert into hive.hive.hivepi_orc  select id, col2, p1 from hive.hive.hivepis_orc;
insert overwrite table hive.hive.hivepi_orc  select id, col2, p1 from hive.hive.hivepis_orc;
-- error, insert overwrite table not allowed for partitioned tables

prepare display_rows_accessed from
select val4_txt, val4
from table(statistics(null,null))
where tdb_name like '%_SCAN %';

select * from hive.hive.hivepis_orc;
select * from hive.hive.hivepts_orc;
select * from hive.hive.hivepi_orc;

control query shape cut;

-- insert some data and add one more partition
sh regrhive.ksh -v -f $REGRTSTDIR/TEST035_b.orc.sql;

-- customer_ddl_orc table is about 3 MB, make a plan with >= 2 ESPs
cqd HIVE_MIN_BYTES_PER_ESP_PARTITION '1000000';
cqd hive_max_string_length '32000';

prepare partinsert from
insert into hive.hive.customer_p_orc
select 
    c_customer_sk,
    c_customer_id,
    c_current_cdemo_sk,
    c_current_hdemo_sk,
    c_current_addr_sk,
    c_first_shipto_date_sk,
    c_first_sales_date_sk,
    c_salutation,
    c_first_name,
    c_last_name,
    c_birth_day,
    c_birth_month,
    c_birth_year,
    c_birth_country,
    c_login,
    c_email_address,
    c_last_review_date,
    c_preferred_cust_flag
from hive.hive.customer_ddl <<+cardinality 2.5e4 >>
where c_customer_sk < 20000
      -- blank partition column values not yet supported
      and c_preferred_cust_flag <> ' '
order by c_customer_sk;

-- go back to the smaller string length
cqd HIVE_MAX_STRING_LENGTH '32' ;

-- verify that we are indeed seeing a parallel plan
select count(*)
from table(explain(null,'PARTINSERT'))
where operator = 'ESP_EXCHANGE';

explain options 'f' partinsert;

execute partinsert;

insert into customer_temp_orc 
select * from customer 
where c_customer_sk between 20000 and 39999;

-- query cache hit, no validation at all
  select c_preferred_cust_flag,
         count(*) 
  from customer_ddl_orc 
  group by 1 
  order by 1
  ;

-- vary query to avoid query cache hit
prepare s2 from 
  select c_preferred_cust_flag,
         count(c_customer_sk) 
  from customer_ddl_orc 
  group by 1 
  order by 1
  ;

prepare s2part from
  select c_preferred_cust_flag,
         count(c_customer_sk) -- avoid query cache
  from customer_p_orc 
  group by 1 
  order by 1
  ;
execute s1;
-- because we don't invalidate in the executor,
-- this should still return 0 rows

execute s2;
-- should get an NATable cache
-- hit, we should notice the change in the table
-- and return the correct result

execute s1part;
-- because we don't invalidate in the executor,
-- this should still return 0 rows

execute s2part;
-- although this should get an NATable cache
-- hit, we should notice the change in the table
-- and return the correct result

-- add duplicate rows to customer_p_orc
insert into customer_p_orc
select 
    c_customer_sk,
    c_customer_id,
    c_current_cdemo_sk,
    c_current_hdemo_sk,
    c_current_addr_sk,
    c_first_shipto_date_sk,
    c_first_sales_date_sk,
    c_salutation,
    c_first_name,
    c_last_name,
    c_birth_day,
    c_birth_month,
    c_birth_year,
    c_birth_country,
    c_login,
    c_email_address,
    c_last_review_date,
    c_preferred_cust_flag
from customer_ddl
where c_customer_sk between 20000 and 24999
      -- blank partition column values not yet supported
      and c_preferred_cust_flag <> ' '
order by c_customer_sk;

-- no query cache hit, but NATable cache hit
prepare s3 from 
  select count(*) 
  from customer_ddl_orc 
  ;

-- no query cache hit, but NATable cache hit
prepare s3part from
  select c_preferred_cust_flag,
         count(c_customer_id) 
  from customer_p_orc 
  group by 1 
  order by 1
  ;
execute s1;
-- s1 should still return 0 rows - for now
execute s2;
execute s3;
execute s1part;
-- s1 should still return 0 rows - for now
execute s2part;
execute s3part;

-- overwrite customer_p_orc with auto-generated partitions
sh regrhive.ksh -v -f $REGRTSTDIR/TEST035_d.orc.sql;

prepare s4 from 
  select c_preferred_cust_flag,
         count(*) 
  from customer_ddl_orc 
  group by 1 
  order by 1
  ;
prepare s4part from
  select c_preferred_cust_flag,
         count(*) 
  from customer_p_orc 
  group by 1 
  order by 1
  ;
execute s2;
execute s4;
execute s2part;
-- error 8442 since the files we are trying to open no longer exist
execute s4part;

-- partition elimination on ORC table
select * from hive.hive.hivepio_orc where p1=2;
execute display_rows_accessed;
select * from hive.hive.hivepio_orc where p1 in (1,3);
execute display_rows_accessed;
select * from hive.hive.hivepdo_orc where p1d >= date '2002-12-31';
execute display_rows_accessed;

-- this pred can neither be pushed to ORC nor used as
-- a partition elimination predicate
select * from hive.hive.hivepio_orc where p1=1 or col2<10;

-- tests for orc timestamp mismatch check
cqd auto_query_retry_warnings 'ON';

sh echo "drop table torc;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

sh echo "create table torc(a int) stored as orc;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

select a from hive.hive.torc;

sh echo "insert into torc values (1);" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

select a from hive.hive.torc;
insert into hive.hive.torc values (2);
select a from hive.hive.torc;

sh echo "drop table torc;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

sh echo "create table torc(a int, b int) stored as orc;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

sh echo "insert into torc values (1,2);" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

select a from hive.hive.torc;

select * from hive.hive.torc;

-- tests for orc CHAR/VARCHAR datatypes
cqd auto_query_retry_warnings 'ON';
cqd hive_max_string_length '5';

-- run against hive/text table
drop external table if exists torc10 for hive.hive.torc10;
sh echo "drop table torc10;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

sh echo "create table torc10(a char(2), b varchar(3), c char(5), d varchar(6), e string, f string, g char(2), h varchar(3), i char(3), j varchar(3));" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

obey TEST035(extTabQueries);

-- run against ORC table
drop external table if exists torc10 for hive.hive.torc10;
sh echo "drop table torc10;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

sh echo "create table torc10(a char(2), b varchar(3), c char(5), d varchar(6), e string, f string, g char(2), h varchar(3), i char(3), j varchar(3)) stored as orc;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

obey TEST035(extTabQueries);

log;
exit;

?section extTabQueries
showddl hive.hive.torc10;
insert into hive.hive.torc10 values 
   ('ab', 'cde', 'ab', 'cde', 'ab', 'cde', 'ab', 'cde', '11', '222');
                                    
select * from hive.hive.torc10;

drop external table if exists torc10 for hive.hive.torc10;
create external table torc10 
        (a char(2), b varchar(3),
         c char(5), d varchar(6), 
         e char(2), f varchar(3),
         g char(2) character set utf8, h varchar(3) character set utf8,
         i tinyint, j int)
     for hive.hive.torc10;

showddl hive.hive.torc10;
select * from hive.hive.torc10;

insert into hive.hive.torc10 values
  ('x', 'yz', 'x', 'yz', 'x', 'yz', 'x', 'yz', 33, 444);

select * from hive.hive.torc10;


-- error cases

-- overflow error during insert. Not currently detected.
insert into hive.hive.torc10 values
  ('x', 'yz', 'x', 'yz', 'x', 'yz', 'x', 'yz', 333, 444);

-- incommpatible datatype against external table
insert into hive.hive.torc10 values 
   ('ab', 'cde', 'ab', 'cde', 'ab', 'cde', 'ab', 'cde', '11', '222');

-- number of values less than number of columns
insert into hive.hive.torc10 values 
   ('ab', 'cde', 'ab', 'cde', 'ab', 'cde', 'ab', 'cde');

-- overflow error detected during select
truncate hive.hive.torc10;
sh echo "insert into torc10 values ('a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', '555', '666');" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;
select * from hive.hive.torc10;

-- incompatible values in hive table validated and detected during select
truncate hive.hive.torc10;
sh echo "insert into torc10 values ('a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a');" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;
select * from hive.hive.torc10;

-- drop tables
drop external table if exists torc10 for hive.hive.torc10;
sh echo "drop table torc10;" > TEST035_junk;
sh regrhive.ksh -f TEST035_junk;

